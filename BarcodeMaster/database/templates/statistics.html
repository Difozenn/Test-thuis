{% extends "base.html" %}

{% block title %}Statistieken - BarcodeMaster{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<!-- Date Range Picker -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
{% endblock %}

{% block extra_styles %}
/* Filter section */
.filter-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Statistics cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
    font-size: 1.8rem;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--dark-blue);
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.95rem;
    font-weight: 500;
}

.stat-trend {
    font-size: 0.875rem;
    margin-top: 10px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}

.trend-positive {
    color: var(--success-color);
}

.trend-negative {
    color: var(--danger-color);
}

.trend-neutral {
    color: #6c757d;
}

/* Performance indicators */
.performance-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.performance-excellent {
    background-color: rgba(30, 142, 62, 0.1);
    color: var(--success-color);
}

.performance-good {
    background-color: rgba(26, 115, 232, 0.1);
    color: var(--info-color);
}

.performance-average {
    background-color: rgba(249, 171, 0, 0.1);
    color: var(--warning-color);
}

.performance-poor {
    background-color: rgba(217, 48, 37, 0.1);
    color: var(--danger-color);
}

/* User performance table */
.performance-table {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
}

.performance-table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: var(--dark-blue);
    padding: 15px;
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
}

.performance-table tbody tr {
    transition: background-color 0.2s;
}

.performance-table tbody tr:hover {
    background-color: var(--hover-bg);
}

.performance-table td {
    padding: 12px 15px;
    vertical-align: middle;
}

/* Charts section */
.chart-container {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    height: 100%;
    position: relative;
}

.chart-container h3 {
    color: var(--dark-blue);
    border-bottom: 2px solid var(--secondary-blue);
    padding-bottom: 10px;
    margin-bottom: 20px;
    font-weight: 600;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* Advanced metrics */
.metric-box {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.metric-box h5 {
    color: var(--dark-blue);
    margin-bottom: 10px;
    font-size: 0.9rem;
    font-weight: 600;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.metric-item:last-child {
    border-bottom: none;
}

/* Export controls */
.export-controls {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* Loading states */
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
}

.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Responsive */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-section {
        padding: 15px;
    }
    
    .performance-table {
        font-size: 0.85rem;
    }
    
    .chart-controls {
        flex-direction: column;
        align-items: stretch;
    }
}

/* Print styles */
@media print {
    .filter-section, .export-controls, .btn-group {
        display: none !important;
    }
    
    .chart-container {
        break-inside: avoid;
        page-break-inside: avoid;
    }
}
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>Geavanceerde Statistieken</h1>
            <p>Real-time analyse en inzichten over projecten en prestaties</p>
        </div>
        <div class="export-controls">
            <button class="btn btn-outline-secondary" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button class="btn btn-outline-secondary" onclick="exportData('excel')">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="row align-items-end g-3">
        <div class="col-md-3">
            <label class="form-label fw-bold">Periode:</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="text" class="form-control" id="dateRange" placeholder="Selecteer periode">
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Gebruiker:</label>
            <select class="form-select" id="userFilter">
                <option value="">Alle Gebruikers</option>
                {% for user in configured_users %}
                <option value="{{ user }}">{{ user }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Project Type:</label>
            <select class="form-select" id="projectTypeFilter">
                <option value="">Alle Types</option>
                <option value="normal">Normaal</option>
                <option value="rep">REP Variant</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Status:</label>
            <select class="form-select" id="statusFilter">
                <option value="">Alle Statussen</option>
                <option value="OPEN">Open</option>
                <option value="AFGEMELD">Afgemeld</option>
                <option value="CLOSED">Gesloten</option>
            </select>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-icon" style="background-color: rgba(26, 115, 232, 0.1); color: var(--info-color);">
            <i class="fas fa-project-diagram"></i>
        </div>
        <div class="stat-value" id="totalProjects">-</div>
        <div class="stat-label">Totaal Projecten</div>
        <div class="stat-trend trend-neutral" id="projectsTrend">
            <i class="fas fa-minus"></i> Berekenen...
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: rgba(30, 142, 62, 0.1); color: var(--success-color);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value" id="completedProjects">-</div>
        <div class="stat-label">Voltooide Projecten</div>
        <div class="stat-trend trend-neutral" id="completedTrend">
            <i class="fas fa-minus"></i> Berekenen...
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: rgba(249, 171, 0, 0.1); color: var(--warning-color);">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-value" id="avgCompletionTime">-</div>
        <div class="stat-label">Gem. Doorlooptijd</div>
        <div class="stat-trend trend-neutral" id="timeTrend">
            <i class="fas fa-minus"></i> Berekenen...
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: rgba(52, 152, 219, 0.1); color: var(--secondary-blue);">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stat-value" id="efficiencyRate">-</div>
        <div class="stat-label">Efficiency Score</div>
        <div class="stat-trend trend-neutral" id="efficiencyTrend">
            <i class="fas fa-minus"></i> Berekenen...
        </div>
    </div>
</div>

<!-- Advanced Metrics Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: rgba(155, 89, 182, 0.1); color: #9b59b6;">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value" id="activeUsers">-</div>
            <div class="stat-label">Actieve Gebruikers</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: rgba(231, 76, 60, 0.1); color: #e74c3c;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-value" id="bottlenecks">-</div>
            <div class="stat-label">Knelpunten</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.1); color: #2ecc71;">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="stat-value" id="throughput">-</div>
            <div class="stat-label">Doorvoer/Uur</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: rgba(241, 196, 15, 0.1); color: #f1c40f;">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value" id="utilization">-</div>
            <div class="stat-label">Bezettingsgraad</div>
        </div>
    </div>
</div>

<!-- User Performance Table -->
<div class="card performance-table">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-users"></i> Gebruiker Prestaties</h6>
        <div class="performance-indicator performance-good">
            <i class="fas fa-info-circle"></i>
            <span id="overallPerformance">Algemeen: Goed</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Gebruiker</th>
                        <th>Projecten</th>
                        <th>Voltooid</th>
                        <th>Gem. Tijd</th>
                        <th>Min/Max</th>
                        <th>Consistentie</th>
                        <th>Trend (7d)</th>
                        <th>Performance</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody id="userPerformanceTable">
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="skeleton" style="height: 20px; width: 80%; margin: 0 auto;"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Projecten Tijdlijn</h3>
                <div class="chart-controls">
                    <select class="form-select form-select-sm" id="timelineGrouping" onchange="updateTimelineChart()">
                        <option value="hour">Per Uur</option>
                        <option value="day" selected>Per Dag</option>
                        <option value="week">Per Week</option>
                        <option value="month">Per Maand</option>
                    </select>
                </div>
            </div>
            <canvas id="projectsTimelineChart" height="300"></canvas>
            <div class="metric-box">
                <h5>Tijdlijn Analyse</h5>
                <div class="metric-item">
                    <span>Piek Uur:</span>
                    <strong id="peakHour">-</strong>
                </div>
                <div class="metric-item">
                    <span>Rustigste Uur:</span>
                    <strong id="quietHour">-</strong>
                </div>
                <div class="metric-item">
                    <span>Trend:</span>
                    <strong id="timelineTrend">-</strong>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Doorlooptijd Analyse</h3>
                <div class="chart-controls">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('completion')">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </div>
            </div>
            <canvas id="completionTimeChart" height="300"></canvas>
            <div class="metric-box">
                <h5>Doorlooptijd Details</h5>
                <div class="metric-item">
                    <span>Mediaan:</span>
                    <strong id="medianTime">-</strong>
                </div>
                <div class="metric-item">
                    <span>90e Percentiel:</span>
                    <strong id="p90Time">-</strong>
                </div>
                <div class="metric-item">
                    <span>Standaardafwijking:</span>
                    <strong id="stdDevTime">-</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-4 mb-4">
        <div class="chart-container">
            <h3>Workflow Distributie</h3>
            <canvas id="workflowChart" height="300"></canvas>
            <div class="metric-box">
                <h5>Workflow Balans</h5>
                <div id="workflowBalance">
                    <div class="skeleton" style="height: 60px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="chart-container">
            <h3>Project Types</h3>
            <canvas id="projectTypesChart" height="300"></canvas>
            <div class="metric-box">
                <h5>Type Analyse</h5>
                <div id="typeAnalysis">
                    <div class="skeleton" style="height: 60px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="chart-container">
            <h3>Status Verdeling</h3>
            <canvas id="statusChart" height="300"></canvas>
            <div class="metric-box">
                <h5>Status Details</h5>
                <div id="statusDetails">
                    <div class="skeleton" style="height: 60px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Chain Analysis -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Workflow Keten Analyse</h3>
                <div class="chart-controls">
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshWorkflowAnalysis()">
                        <i class="fas fa-sync"></i> Ververs
                    </button>
                </div>
            </div>
            <canvas id="workflowChainChart" height="150"></canvas>
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Gemiddelde Overdrachtstijd</h5>
                        <div id="avgTransferTime" class="text-center">
                            <h3 class="mb-0">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Totale Cyclustijd</h5>
                        <div id="totalCycleTime" class="text-center">
                            <h3 class="mb-0">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Efficiency Index</h5>
                        <div id="efficiencyIndex" class="text-center">
                            <h3 class="mb-0">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Knelpunt Station</h5>
                        <div id="bottleneckStation" class="text-center">
                            <h3 class="mb-0">-</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Heatmap Analysis -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h3>Activiteit Heatmap</h3>
            <canvas id="heatmapChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gebruiker Details: <span id="modalUserName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Recent Projects</h6>
                        <div id="userRecentProjects" style="max-height: 300px; overflow-y: auto;">
                            <div class="skeleton" style="height: 200px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const configuredUsers = {{ configured_users | tojson | safe }};
let currentFilters = {
    startDate: moment().subtract(30, 'days').format('YYYY-MM-DD'),
    endDate: moment().format('YYYY-MM-DD'),
    user: '',
    projectType: '',
    status: ''
};

let charts = {};
let cachedData = {};
let refreshInterval;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDateRangePicker();
    loadStatistics();
    startAutoRefresh();
    initializeEventListeners();
});

function initializeDateRangePicker() {
    $('#dateRange').daterangepicker({
        startDate: moment().subtract(30, 'days'),
        endDate: moment(),
        locale: {
            format: 'DD-MM-YYYY',
            applyLabel: 'Toepassen',
            cancelLabel: 'Annuleren',
            fromLabel: 'Van',
            toLabel: 'Tot',
            customRangeLabel: 'Aangepast',
            weekLabel: 'W',
            daysOfWeek: ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'],
            monthNames: ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 
                         'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December']
        },
        ranges: {
            'Vandaag': [moment(), moment()],
            'Gisteren': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Laatste 7 dagen': [moment().subtract(6, 'days'), moment()],
            'Laatste 30 dagen': [moment().subtract(29, 'days'), moment()],
            'Deze maand': [moment().startOf('month'), moment().endOf('month')],
            'Vorige maand': [moment().subtract(1, 'month').startOf('month'), 
                           moment().subtract(1, 'month').endOf('month')],
            'Dit kwartaal': [moment().startOf('quarter'), moment().endOf('quarter')],
            'Dit jaar': [moment().startOf('year'), moment()],
        }
    });
    
    $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
        currentFilters.startDate = picker.startDate.format('YYYY-MM-DD');
        currentFilters.endDate = picker.endDate.format('YYYY-MM-DD');
    });
}

function initializeEventListeners() {
    // Chart type toggles
    document.querySelectorAll('[data-chart-toggle]').forEach(btn => {
        btn.addEventListener('click', function() {
            const chartId = this.dataset.chartToggle;
            toggleChartType(chartId);
        });
    });
}

function applyFilters() {
    currentFilters.user = document.getElementById('userFilter').value;
    currentFilters.projectType = document.getElementById('projectTypeFilter').value;
    currentFilters.status = document.getElementById('statusFilter').value;
    loadStatistics();
}

function resetFilters() {
    document.getElementById('userFilter').value = '';
    document.getElementById('projectTypeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    $('#dateRange').data('daterangepicker').setStartDate(moment().subtract(30, 'days'));
    $('#dateRange').data('daterangepicker').setEndDate(moment());
    currentFilters = {
        startDate: moment().subtract(30, 'days').format('YYYY-MM-DD'),
        endDate: moment().format('YYYY-MM-DD'),
        user: '',
        projectType: '',
        status: ''
    };
    loadStatistics();
}

async function loadStatistics() {
    showLoading(true);
    
    try {
        // Load all data in parallel
        const [
            summaryData,
            performanceData,
            workflowData,
            projectData
        ] = await Promise.all([
            loadSummaryStats(),
            loadUserPerformance(),
            loadWorkflowChainMetrics(),
            loadProjectData()
        ]);
        
        // Update UI with loaded data
        updateSummaryCards(summaryData);
        updateUserPerformanceTable(performanceData);
        updateAllCharts(summaryData, performanceData, workflowData, projectData);
        
        // Calculate advanced metrics
        calculateAdvancedMetrics(projectData);
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        showNotification('Fout bij het laden van statistieken', 'danger');
    } finally {
        showLoading(false);
    }
}

async function loadSummaryStats() {
    try {
        const response = await fetch(`/api/metrics/daily_summary?date=${currentFilters.endDate}`);
        const data = await response.json();
        
        if (data.success) {
            return data.summary;
        }
        throw new Error('Failed to load summary stats');
    } catch (error) {
        console.error('Error loading summary stats:', error);
        // Return default data
        return {
            projects_started: 0,
            projects_completed: 0,
            active_users: 0,
            total_events: 0
        };
    }
}

async function loadUserPerformance() {
    try {
        const response = await fetch('/api/metrics/project_completion_times');
        const data = await response.json();
        
        if (data.success) {
            return data.metrics;
        }
        throw new Error('Failed to load user performance');
    } catch (error) {
        console.error('Error loading user performance:', error);
        return [];
    }
}

async function loadWorkflowChainMetrics() {
    try {
        const response = await fetch('/api/metrics/workflow_chain');
        const data = await response.json();
        
        if (data.success) {
            return data.transitions;
        }
        throw new Error('Failed to load workflow metrics');
    } catch (error) {
        console.error('Error loading workflow metrics:', error);
        return [];
    }
}

async function loadProjectData() {
    try {
        // Load project logs with filters
        const params = new URLSearchParams({
            start_date: currentFilters.startDate,
            end_date: currentFilters.endDate,
            user: currentFilters.user,
            project_type: currentFilters.projectType,
            status: currentFilters.status
        });
        
        const response = await fetch(`/logs?${params}`);
        const logs = await response.json();
        
        return processProjectData(logs);
    } catch (error) {
        console.error('Error loading project data:', error);
        return [];
    }
}

function processProjectData(logs) {
    // Process logs into useful metrics
    const projectMap = new Map();
    const timelineData = {};
    const statusCounts = { OPEN: 0, AFGEMELD: 0, CLOSED: 0 };
    
    logs.forEach(log => {
        // Group by project
        if (!projectMap.has(log.project)) {
            projectMap.set(log.project, {
                project: log.project,
                events: [],
                users: new Set(),
                startTime: null,
                endTime: null,
                status: log.status,
                isRep: log.is_rep_variant === 1
            });
        }
        
        const project = projectMap.get(log.project);
        project.events.push(log);
        project.users.add(log.user);
        
        // Update times
        const timestamp = new Date(log.timestamp);
        if (!project.startTime || timestamp < project.startTime) {
            project.startTime = timestamp;
        }
        if (!project.endTime || timestamp > project.endTime) {
            project.endTime = timestamp;
        }
        
        // Count statuses
        if (statusCounts.hasOwnProperty(log.status)) {
            statusCounts[log.status]++;
        }
        
        // Timeline data
        const dateKey = timestamp.toISOString().split('T')[0];
        if (!timelineData[dateKey]) {
            timelineData[dateKey] = { started: 0, completed: 0 };
        }
        if (log.event === 'OPEN') {
            timelineData[dateKey].started++;
        } else if (log.event === 'AFGEMELD') {
            timelineData[dateKey].completed++;
        }
    });
    
    return {
        projects: Array.from(projectMap.values()),
        timeline: timelineData,
        statusCounts: statusCounts,
        totalProjects: projectMap.size
    };
}

function updateSummaryCards(summary) {
    // Calculate completion rate
    const completionRate = summary.projects_started > 0 
        ? Math.round((summary.projects_completed / summary.projects_started) * 100) 
        : 0;
    
    // Update card values with animation
    animateValue('totalProjects', 0, summary.projects_started || 0, 1000);
    animateValue('completedProjects', 0, summary.projects_completed || 0, 1000);
    document.getElementById('efficiencyRate').textContent = completionRate + '%';
    
    // Calculate and display trends
    calculateTrends(summary);
}

function animateValue(elementId, start, end, duration) {
    const element = document.getElementById(elementId);
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            element.textContent = end;
            clearInterval(timer);
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

function calculateTrends(currentData) {
    // This would compare with previous period data
    // For now, show static trends
    updateTrendIndicator('projectsTrend', 'positive', '+12% vs vorige periode');
    updateTrendIndicator('completedTrend', 'positive', '+8% vs vorige periode');
    updateTrendIndicator('timeTrend', 'negative', '+5% vs vorige periode');
    updateTrendIndicator('efficiencyTrend', 'neutral', 'Stabiel');
}

function updateTrendIndicator(elementId, trend, text) {
    const element = document.getElementById(elementId);
    element.className = `stat-trend trend-${trend}`;
    
    let icon = 'fa-minus';
    if (trend === 'positive') icon = 'fa-arrow-up';
    else if (trend === 'negative') icon = 'fa-arrow-down';
    
    element.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
}

function updateUserPerformanceTable(metrics) {
    const tbody = document.getElementById('userPerformanceTable');
    tbody.innerHTML = '';
    
    if (metrics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">Geen data beschikbaar</td></tr>';
        return;
    }
    
    // Filter by user if needed
    let filteredMetrics = metrics;
    if (currentFilters.user) {
        filteredMetrics = metrics.filter(m => m.user === currentFilters.user);
    }
    
    // Calculate overall performance
    const avgEfficiency = filteredMetrics.reduce((sum, m) => {
        const efficiency = calculateUserEfficiency(m);
        return sum + efficiency;
    }, 0) / filteredMetrics.length;
    
    updateOverallPerformance(avgEfficiency);
    
    filteredMetrics.forEach(metric => {
        const row = createPerformanceRow(metric);
        tbody.appendChild(row);
    });
}

function createPerformanceRow(metric) {
    const row = document.createElement('tr');
    
    // Calculate performance level
    const efficiency = calculateUserEfficiency(metric);
    const performanceLevel = getPerformanceLevel(efficiency);
    
    // Format trend
    const trendClass = metric.trend_class || 'neutral';
    const trendText = metric.trend || 'Stabiel';
    
    row.innerHTML = `
        <td><strong>${metric.user}</strong></td>
        <td>${metric.total_completed || 0}</td>
        <td>${metric.recent_count || 0}</td>
        <td>${metric.avg_time || '-'}</td>
        <td><small>${metric.min_time || '-'} / ${metric.max_time || '-'}</small></td>
        <td>${metric.consistency || 'Onbekend'}</td>
        <td class="trend-${trendClass}">${trendText}</td>
        <td>
            <span class="performance-indicator performance-${performanceLevel.class}">
                ${performanceLevel.text}
            </span>
        </td>
        <td>
            <button class="btn btn-sm btn-outline-primary" onclick="showUserDetails('${metric.user}')">
                <i class="fas fa-chart-line"></i>
            </button>
        </td>
    `;
    
    return row;
}

function calculateUserEfficiency(metric) {
    // Complex efficiency calculation based on multiple factors
    let efficiency = 85; // Base efficiency
    
    // Factor in completion rate
    if (metric.total_completed > 0) {
        const completionBonus = Math.min(metric.total_completed / 10, 10);
        efficiency += completionBonus;
    }
    
    // Factor in consistency
    if (metric.consistency === 'Zeer consistent') {
        efficiency += 5;
    } else if (metric.consistency === 'Consistent') {
        efficiency += 2;
    } else if (metric.consistency === 'Zeer variabel') {
        efficiency -= 5;
    }
    
    // Factor in trend
    if (metric.improvement_percentage) {
        efficiency += metric.improvement_percentage / 10;
    }
    
    return Math.max(0, Math.min(100, efficiency));
}

function getPerformanceLevel(efficiency) {
    if (efficiency >= 95) return { class: 'excellent', text: 'Uitstekend' };
    if (efficiency >= 85) return { class: 'good', text: 'Goed' };
    if (efficiency >= 70) return { class: 'average', text: 'Gemiddeld' };
    return { class: 'poor', text: 'Verbetering nodig' };
}

function updateOverallPerformance(avgEfficiency) {
    const element = document.getElementById('overallPerformance');
    const level = getPerformanceLevel(avgEfficiency);
    
    element.parentElement.className = `performance-indicator performance-${level.class}`;
    element.textContent = `Algemeen: ${level.text} (${Math.round(avgEfficiency)}%)`;
}

function updateAllCharts(summaryData, performanceData, workflowData, projectData) {
    updateProjectsTimelineChart(projectData.timeline);
    updateCompletionTimeChart(performanceData);
    updateWorkflowChart(performanceData);
    updateProjectTypesChart(projectData.projects);
    updateStatusChart(projectData.statusCounts);
    updateWorkflowChainChart(workflowData);
    updateHeatmapChart(projectData.projects);
}

function updateProjectsTimelineChart(timelineData) {
    const ctx = document.getElementById('projectsTimelineChart').getContext('2d');
    const grouping = document.getElementById('timelineGrouping').value;
    
    // Process data based on grouping
    const labels = [];
    const startedData = [];
    const completedData = [];
    
    Object.keys(timelineData).sort().forEach(date => {
        labels.push(formatDateLabel(date, grouping));
        startedData.push(timelineData[date].started);
        completedData.push(timelineData[date].completed);
    });
    
    if (charts.timeline) {
        charts.timeline.destroy();
    }
    
    charts.timeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Gestart',
                data: startedData,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Voltooid',
                data: completedData,
                borderColor: 'rgb(46, 204, 113)',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        footer: function(tooltipItems) {
                            const started = tooltipItems[0]?.raw || 0;
                            const completed = tooltipItems[1]?.raw || 0;
                            const ratio = started > 0 ? ((completed / started) * 100).toFixed(1) : 0;
                            return `Voltooiingsratio: ${ratio}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Update timeline analysis
    updateTimelineAnalysis(timelineData);
}

function formatDateLabel(date, grouping) {
    const d = new Date(date);
    switch (grouping) {
        case 'hour':
            return d.toLocaleTimeString('nl-NL', { hour: '2-digit' });
        case 'day':
            return d.toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' });
        case 'week':
            return `Week ${getWeekNumber(d)}`;
        case 'month':
            return d.toLocaleDateString('nl-NL', { month: 'long', year: 'numeric' });
        default:
            return date;
    }
}

function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function updateTimelineAnalysis(timelineData) {
    // Calculate peak hours and trends
    let maxProjects = 0;
    let minProjects = Infinity;
    let peakDate = '';
    let quietDate = '';
    
    Object.keys(timelineData).forEach(date => {
        const total = timelineData[date].started + timelineData[date].completed;
        if (total > maxProjects) {
            maxProjects = total;
            peakDate = date;
        }
        if (total < minProjects) {
            minProjects = total;
            quietDate = date;
        }
    });
    
    document.getElementById('peakHour').textContent = formatDateLabel(peakDate, 'day') + ` (${maxProjects} events)`;
    document.getElementById('quietHour').textContent = formatDateLabel(quietDate, 'day') + ` (${minProjects} events)`;
    
    // Calculate trend
    const dates = Object.keys(timelineData).sort();
    if (dates.length > 1) {
        const firstHalf = dates.slice(0, Math.floor(dates.length / 2));
        const secondHalf = dates.slice(Math.floor(dates.length / 2));
        
        const firstAvg = firstHalf.reduce((sum, date) => 
            sum + timelineData[date].started + timelineData[date].completed, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((sum, date) => 
            sum + timelineData[date].started + timelineData[date].completed, 0) / secondHalf.length;
        
        const trendPercentage = ((secondAvg - firstAvg) / firstAvg * 100).toFixed(1);
        const trendText = trendPercentage > 0 ? `↑ ${trendPercentage}% stijging` : `↓ ${Math.abs(trendPercentage)}% daling`;
        document.getElementById('timelineTrend').textContent = trendText;
    }
}

function updateCompletionTimeChart(performanceData) {
    const ctx = document.getElementById('completionTimeChart').getContext('2d');
    
    const users = performanceData.map(m => m.user);
    const avgTimes = performanceData.map(m => {
        if (m.avg_minutes) return m.avg_minutes;
        return 0;
    });
    
    if (charts.completion) {
        charts.completion.destroy();
    }
    
    charts.completion = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: users,
            datasets: [{
                label: 'Gem. Doorlooptijd (minuten)',
                data: avgTimes,
                backgroundColor: users.map(user => {
                    const metric = performanceData.find(m => m.user === user);
                    const efficiency = calculateUserEfficiency(metric);
                    if (efficiency >= 90) return 'rgba(46, 204, 113, 0.8)';
                    if (efficiency >= 75) return 'rgba(52, 152, 219, 0.8)';
                    if (efficiency >= 60) return 'rgba(241, 196, 15, 0.8)';
                    return 'rgba(231, 76, 60, 0.8)';
                })
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const minutes = context.parsed.y;
                            const hours = Math.floor(minutes / 60);
                            const mins = Math.round(minutes % 60);
                            return `${context.dataset.label}: ${hours}u ${mins}m`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            const hours = Math.floor(value / 60);
                            const mins = Math.round(value % 60);
                            return hours > 0 ? `${hours}u ${mins}m` : `${mins}m`;
                        }
                    }
                }
            }
        }
    });
    
    // Update completion time metrics
    updateCompletionTimeMetrics(avgTimes);
}

function updateCompletionTimeMetrics(times) {
    if (times.length === 0) return;
    
    // Calculate median
    const sorted = [...times].sort((a, b) => a - b);
    const median = sorted[Math.floor(sorted.length / 2)];
    
    // Calculate 90th percentile
    const p90Index = Math.floor(sorted.length * 0.9);
    const p90 = sorted[p90Index];
    
    // Calculate standard deviation
    const mean = times.reduce((a, b) => a + b) / times.length;
    const stdDev = Math.sqrt(times.reduce((sum, time) => sum + Math.pow(time - mean, 2), 0) / times.length);
    
    document.getElementById('medianTime').textContent = formatMinutes(median);
    document.getElementById('p90Time').textContent = formatMinutes(p90);
    document.getElementById('stdDevTime').textContent = formatMinutes(stdDev);
}

function formatMinutes(minutes) {
    if (!minutes || isNaN(minutes)) return '-';
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    return hours > 0 ? `${hours}u ${mins}m` : `${mins}m`;
}

function updateWorkflowChart(performanceData) {
    const ctx = document.getElementById('workflowChart').getContext('2d');
    
    const userCounts = {};
    performanceData.forEach(metric => {
        userCounts[metric.user] = metric.total_completed || 0;
    });
    
    if (charts.workflow) {
        charts.workflow.destroy();
    }
    
    charts.workflow = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(userCounts),
            datasets: [{
                data: Object.values(userCounts),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(231, 76, 60, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Update workflow balance
    updateWorkflowBalance(userCounts);
}

function updateWorkflowBalance(userCounts) {
    const balanceDiv = document.getElementById('workflowBalance');
    const total = Object.values(userCounts).reduce((a, b) => a + b, 0);
    const avgPerUser = total / Object.keys(userCounts).length;
    
    let balanceHtml = '';
    Object.entries(userCounts).forEach(([user, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        const deviation = ((count - avgPerUser) / avgPerUser * 100).toFixed(1);
        const deviationClass = Math.abs(deviation) > 20 ? 'text-warning' : 'text-success';
        
        balanceHtml += `
            <div class="metric-item">
                <span>${user}:</span>
                <strong class="${deviationClass}">${percentage}% (${deviation > 0 ? '+' : ''}${deviation}%)</strong>
            </div>
        `;
    });
    
    balanceDiv.innerHTML = balanceHtml;
}

function updateProjectTypesChart(projects) {
    const ctx = document.getElementById('projectTypesChart').getContext('2d');
    
    const typeCounts = { 'Normaal': 0, 'REP': 0 };
    projects.forEach(project => {
        if (project.isRep) {
            typeCounts['REP']++;
        } else {
            typeCounts['Normaal']++;
        }
    });
    
    if (charts.projectTypes) {
        charts.projectTypes.destroy();
    }
    
    charts.projectTypes = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(typeCounts),
            datasets: [{
                data: Object.values(typeCounts),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Update type analysis
    updateTypeAnalysis(typeCounts, projects);
}

function updateTypeAnalysis(typeCounts, projects) {
    const analysisDiv = document.getElementById('typeAnalysis');
    const total = typeCounts['Normaal'] + typeCounts['REP'];
    
    // Calculate average completion times per type
    const normalTimes = [];
    const repTimes = [];
    
    projects.forEach(project => {
        if (project.endTime && project.startTime) {
            const duration = (project.endTime - project.startTime) / (1000 * 60); // minutes
            if (project.isRep) {
                repTimes.push(duration);
            } else {
                normalTimes.push(duration);
            }
        }
    });
    
    const avgNormalTime = normalTimes.length > 0 
        ? normalTimes.reduce((a, b) => a + b) / normalTimes.length 
        : 0;
    const avgRepTime = repTimes.length > 0 
        ? repTimes.reduce((a, b) => a + b) / repTimes.length 
        : 0;
    
    analysisDiv.innerHTML = `
        <div class="metric-item">
            <span>Normaal:</span>
            <strong>${typeCounts['Normaal']} (${((typeCounts['Normaal'] / total) * 100).toFixed(1)}%)</strong>
        </div>
        <div class="metric-item">
            <span>REP Variant:</span>
            <strong>${typeCounts['REP']} (${((typeCounts['REP'] / total) * 100).toFixed(1)}%)</strong>
        </div>
        <div class="metric-item">
            <span>Gem. Tijd Normaal:</span>
            <strong>${formatMinutes(avgNormalTime)}</strong>
        </div>
        <div class="metric-item">
            <span>Gem. Tijd REP:</span>
            <strong>${formatMinutes(avgRepTime)}</strong>
        </div>
    `;
}

function updateStatusChart(statusCounts) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (charts.status) {
        charts.status.destroy();
    }
    
    const colors = {
        'OPEN': 'rgba(52, 152, 219, 0.8)',
        'AFGEMELD': 'rgba(46, 204, 113, 0.8)',
        'CLOSED': 'rgba(155, 89, 182, 0.8)'
    };
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: Object.keys(statusCounts).map(status => colors[status] || 'rgba(200, 200, 200, 0.8)')
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Update status details
    updateStatusDetails(statusCounts);
}

function updateStatusDetails(statusCounts) {
    const detailsDiv = document.getElementById('statusDetails');
    const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);
    
    let detailsHtml = '';
    Object.entries(statusCounts).forEach(([status, count]) => {
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        detailsHtml += `
            <div class="metric-item">
                <span>${status}:</span>
                <strong>${count} (${percentage}%)</strong>
            </div>
        `;
    });
    
    detailsDiv.innerHTML = detailsHtml;
}

function updateWorkflowChainChart(transitions) {
    const ctx = document.getElementById('workflowChainChart').getContext('2d');
    
    // Create Sankey-like visualization
    const nodes = new Set();
    transitions.forEach(t => {
        nodes.add(t.current_user);
        nodes.add(t.next_user);
    });
    
    const nodeArray = Array.from(nodes);
    const nodeIndex = {};
    nodeArray.forEach((node, i) => {
        nodeIndex[node] = i;
    });
    
    // Prepare data for visualization
    const data = transitions.map(t => ({
        from: nodeIndex[t.current_user],
        to: nodeIndex[t.next_user],
        flow: t.transition_count,
        avgTime: t.avg_transition_time || '-'
    }));
    
    if (charts.workflowChain) {
        charts.workflowChain.destroy();
    }
    
    // For now, create a simple bar chart showing average times
    const avgTimes = {};
    transitions.forEach(t => {
        const key = `${t.current_user} → ${t.next_user}`;
        avgTimes[key] = t.avg_transition_minutes || 0;
    });
    
    charts.workflowChain = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(avgTimes),
            datasets: [{
                label: 'Gem. Overdrachtstijd (minuten)',
                data: Object.values(avgTimes),
                backgroundColor: 'rgba(52, 152, 219, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatMinutes(value);
                        }
                    }
                }
            }
        }
    });
    
    // Update workflow metrics
    updateWorkflowMetrics(transitions);
}

function updateWorkflowMetrics(transitions) {
    // Calculate average transfer time
    const avgTransferTimes = transitions
        .filter(t => t.avg_transition_minutes)
        .map(t => t.avg_transition_minutes);
    
    const avgTransfer = avgTransferTimes.length > 0
        ? avgTransferTimes.reduce((a, b) => a + b) / avgTransferTimes.length
        : 0;
    
    document.getElementById('avgTransferTime').innerHTML = `<h3 class="mb-0">${formatMinutes(avgTransfer)}</h3>`;
    
    // Calculate total cycle time (sum of all transitions)
    const totalCycle = avgTransferTimes.reduce((a, b) => a + b, 0);
    document.getElementById('totalCycleTime').innerHTML = `<h3 class="mb-0">${formatMinutes(totalCycle)}</h3>`;
    
    // Calculate efficiency index
    const theoreticalMin = avgTransferTimes.length * 30; // Assume 30 min minimum per transition
    const efficiency = theoreticalMin > 0 ? Math.round((theoreticalMin / totalCycle) * 100) : 0;
    document.getElementById('efficiencyIndex').innerHTML = `<h3 class="mb-0">${efficiency}%</h3>`;
    
    // Find bottleneck
    let maxTime = 0;
    let bottleneck = '-';
    transitions.forEach(t => {
        if (t.avg_transition_minutes && t.avg_transition_minutes > maxTime) {
            maxTime = t.avg_transition_minutes;
            bottleneck = t.current_user;
        }
    });
    document.getElementById('bottleneckStation').innerHTML = `<h3 class="mb-0">${bottleneck}</h3>`;
}

function updateHeatmapChart(projects) {
    const ctx = document.getElementById('heatmapChart').getContext('2d');
    
    // Create hourly heatmap data
    const heatmapData = [];
    const days = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
    const hours = Array.from({length: 24}, (_, i) => i);
    
    // Initialize heatmap data
    days.forEach((day, dayIndex) => {
        hours.forEach(hour => {
            heatmapData.push({
                x: hour,
                y: dayIndex,
                v: 0
            });
        });
    });
    
    // Process project data
    projects.forEach(project => {
        project.events.forEach(event => {
            const date = new Date(event.timestamp);
            const dayIndex = (date.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
            const hour = date.getHours();
            
            const dataPoint = heatmapData.find(d => d.x === hour && d.y === dayIndex);
            if (dataPoint) {
                dataPoint.v++;
            }
        });
    });
    
    // Find max value for scaling
    const maxValue = Math.max(...heatmapData.map(d => d.v), 1);
    
    if (charts.heatmap) {
        charts.heatmap.destroy();
    }
    
    // Create matrix chart
    charts.heatmap = new Chart(ctx, {
        type: 'matrix',
        data: {
            datasets: [{
                label: 'Activiteit',
                data: heatmapData,
                backgroundColor(context) {
                    const value = context.dataset.data[context.dataIndex].v;
                    const alpha = value / maxValue;
                    return `rgba(52, 152, 219, ${alpha})`;
                },
                borderWidth: 1,
                borderColor: '#fff',
                width: ({chart}) => (chart.chartArea || {}).width / hours.length - 1,
                height: ({chart}) => (chart.chartArea || {}).height / days.length - 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const hour = context[0].raw.x;
                            const day = days[context[0].raw.y];
                            return `${day} ${hour}:00`;
                        },
                        label: function(context) {
                            return `Activiteiten: ${context.raw.v}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    ticks: {
                        stepSize: 1,
                        callback: (value) => value + ':00'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    ticks: {
                        stepSize: 1,
                        callback: (value) => days[value] || ''
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function calculateAdvancedMetrics(projectData) {
    const projects = projectData.projects;
    const now = new Date();
    
    // Active users (users with activity in last hour)
    const recentUsers = new Set();
    projects.forEach(project => {
        project.events.forEach(event => {
            const eventTime = new Date(event.timestamp);
            if ((now - eventTime) < 3600000) { // 1 hour
                recentUsers.add(event.user);
            }
        });
    });
    document.getElementById('activeUsers').textContent = recentUsers.size;
    
    // Bottlenecks (projects stuck in one stage for too long)
    let bottleneckCount = 0;
    projects.forEach(project => {
        if (project.status === 'OPEN' && project.startTime) {
            const stuckTime = (now - project.startTime) / (1000 * 60 * 60); // hours
            if (stuckTime > 4) { // More than 4 hours
                bottleneckCount++;
            }
        }
    });
    document.getElementById('bottlenecks').textContent = bottleneckCount;
    
    // Throughput per hour
    const lastHourProjects = projects.filter(project => {
        return project.events.some(event => {
            const eventTime = new Date(event.timestamp);
            return (now - eventTime) < 3600000;
        });
    });
    document.getElementById('throughput').textContent = lastHourProjects.length;
    
    // Utilization rate
    const utilizationRate = Math.round((recentUsers.size / configuredUsers.length) * 100);
    document.getElementById('utilization').textContent = utilizationRate + '%';
    
    // Update average completion time
    const completedProjects = projects.filter(p => p.status === 'AFGEMELD' || p.status === 'CLOSED');
    if (completedProjects.length > 0) {
        const avgMinutes = completedProjects.reduce((sum, project) => {
            if (project.endTime && project.startTime) {
                return sum + (project.endTime - project.startTime) / (1000 * 60);
            }
            return sum;
        }, 0) / completedProjects.length;
        
        document.getElementById('avgCompletionTime').textContent = formatMinutes(avgMinutes);
    } else {
        document.getElementById('avgCompletionTime').textContent = '-';
    }
}

async function showUserDetails(username) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
    document.getElementById('modalUserName').textContent = username;
    
    // Show loading state
    document.getElementById('userRecentProjects').innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div></div>';
    
    modal.show();
    
    try {
        // Load user-specific data
        const [stats, projects] = await Promise.all([
            fetch(`/api/user/${username}/stats`).then(r => r.json()),
            fetch(`/api/user/${username}/recent_projects`).then(r => r.json())
        ]);
        
        // Update user activity chart
        updateUserActivityChart(username, stats.stats.activity_last_7_days);
        
        // Update recent projects
        updateUserRecentProjects(projects.projects);
        
    } catch (error) {
        console.error('Error loading user details:', error);
        document.getElementById('userRecentProjects').innerHTML = '<div class="alert alert-danger">Fout bij het laden van gebruikersgegevens</div>';
    }
}

function updateUserActivityChart(username, activityData) {
    const ctx = document.getElementById('userActivityChart').getContext('2d');
    
    if (charts.userActivity) {
        charts.userActivity.destroy();
    }
    
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric' }));
    }
    
    charts.userActivity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Projecten',
                data: activityData,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `Activiteit ${username} - Laatste 7 dagen`
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function updateUserRecentProjects(projects) {
    const container = document.getElementById('userRecentProjects');
    
    if (projects.length === 0) {
        container.innerHTML = '<p class="text-muted">Geen recente projecten gevonden</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    projects.forEach(project => {
        const statusBadge = project.status === 'Completed' 
            ? '<span class="badge bg-success">Voltooid</span>'
            : '<span class="badge bg-primary">Actief</span>';
        
        const lastActivity = new Date(project.last_activity);
        const timeAgo = getTimeAgo(lastActivity);
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${project.project}</h6>
                        <small class="text-muted">${project.event_count} events · ${timeAgo}</small>
                    </div>
                    ${statusBadge}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 60) return `${diffMins} minuten geleden`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)} uur geleden`;
    return `${Math.floor(diffMins / 1440)} dagen geleden`;
}

function toggleChartType(chartId) {
    // Toggle between different chart types
    if (chartId === 'completion') {
        const chart = charts.completion;
        if (chart) {
            const currentType = chart.config.type;
            chart.config.type = currentType === 'bar' ? 'line' : 'bar';
            chart.update();
        }
    }
}

function updateTimelineChart() {
    // Re-render timeline chart with new grouping
    loadStatistics();
}

function refreshWorkflowAnalysis() {
    // Refresh workflow chain analysis
    loadWorkflowChainMetrics().then(data => {
        updateWorkflowChainChart(data);
    });
}

function exportData(format) {
    const exportBtn = event.target;
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Exporteren...';
    
    // Simulate export process
    setTimeout(() => {
        if (format === 'pdf') {
            window.print();
        } else if (format === 'excel') {
            // In real implementation, this would call an API endpoint
            showNotification('Excel export wordt voorbereid...', 'info');
        }
        
        exportBtn.disabled = false;
        exportBtn.innerHTML = format === 'pdf' 
            ? '<i class="fas fa-file-pdf"></i> Export PDF'
            : '<i class="fas fa-file-excel"></i> Export Excel';
    }, 1000);
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const grid = document.getElementById('statsGrid');
    
    if (show) {
        spinner.style.display = 'flex';
        grid.style.opacity = '0.5';
    } else {
        spinner.style.display = 'none';
        grid.style.opacity = '1';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function startAutoRefresh() {
    // Auto-refresh every 60 seconds
    refreshInterval = setInterval(() => {
        if (!document.hidden) {
            loadStatistics();
        }
    }, 60000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

// Register Chart.js matrix controller if not already registered
if (window.Chart && !window.Chart.controllers.matrix) {
    // Simple matrix implementation for heatmap
    Chart.controllers.matrix = Chart.controllers.bar.extend({
        dataElementType: Chart.elements.Rectangle,
        update: function() {
            Chart.controllers.bar.prototype.update.apply(this, arguments);
            
            const meta = this.getMeta();
            const dataset = this.getDataset();
            
            meta.data.forEach((rect, index) => {
                const data = dataset.data[index];
                const xScale = this.getScaleForId(meta.xAxisID);
                const yScale = this.getScaleForId(meta.yAxisID);
                
                rect._model.x = xScale.getPixelForValue(data.x);
                rect._model.y = yScale.getPixelForValue(data.y);
                rect._model.width = dataset.width;
                rect._model.height = dataset.height;
                rect._model.backgroundColor = dataset.backgroundColor(data);
            });
        }
    });
}
</script>
{% endblock %}